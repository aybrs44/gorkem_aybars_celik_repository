import cv2
import pandas as pd
import numpy as np
from datetime import datetime
import os
import winsound  # Windows onay sesleri için

# --- AYARLAR ---
EXCEL_YOLU = "Giris_Kayitlari/Personel_Takip.xlsx"
PARLAKLIK_ESIGI = 20  # Nesne kapalıyken parlaklık genelde 10'un altındadır

def onay_sesi(tur="giris"):
    if tur == "giris":
        winsound.Beep(1000, 200) # 1000 Hz, 200 ms (İnce Bip)
    else:
        winsound.Beep(600, 400)  # 600 Hz, 400 ms (Kalın Bip)

def kaydet_excel(isim, soyisim):
    tarih = datetime.now().strftime("%Y-%m-%d")
    saat = datetime.now().strftime("%H:%M:%S")
    
    if not os.path.exists(EXCEL_YOLU):
        df = pd.DataFrame(columns=["İsim", "Soyisim", "Tarih", "Giriş", "Çıkış", "Durum"])
    else:
        df = pd.read_excel(EXCEL_YOLU)

    # Bugün bu kişi zaten işlem yapmış mı?
    kisi_bugun = df[(df['İsim'] == isim) & (df['Tarih'] == tarih)]

    if kisi_bugun.empty:
        # İLK GÖRÜNÜŞ -> GİRİŞ
        yeni_kayit = {"İsim": isim, "Soyisim": soyisim, "Tarih": tarih, "Giriş": saat, "Durum": "İş Başında"}
        df = pd.concat([df, pd.DataFrame([yeni_kayit])], ignore_index=True)
        onay_sesi("giris")
        print(f"{isim} Giriş Yaptı.")
    else:
        # ZATEN GİRİŞİ VAR -> ÇIKIŞ (Eğer Çıkış sütunu boşsa doldur)
        index = kisi_bugun.index[-1]
        if pd.isna(df.loc[index, 'Çıkış']):
            df.loc[index, 'Çıkış'] = saat
            df.loc[index, 'Durum'] = "Mesai Bitti"
            onay_sesi("cikis")
            print(f"{isim} Çıkış Yaptı.")
        else:
            # Zaten hem giriş hem çıkış yapılmışsa tekrar işlem yapma (veya isteğe göre güncelle)
            pass

    df.to_excel(EXCEL_YOLU, index=False)

# Kamera Başlatma
cap = cv2.VideoCapture(0)

while True:
    ret, frame = cap.read()
    if not ret: break

    # --- AKILLI UYKU MODU ---
    gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)
    parlaklik = np.mean(gray)

    if parlaklik < PARLAKLIK_ESIGI:
        # EKRANI SİYAH YAP (İşlemci yorulmasın)
        black_screen = np.zeros((480, 640, 3), dtype=np.uint8)
        cv2.putText(black_screen, "SISTEM UYKUDA (KAPAK KAPALI)", (120, 240), 
                    cv2.FONT_HERSHEY_SIMPLEX, 0.8, (0, 0, 255), 2)
        cv2.imshow("Gorkem Personel Takip", black_screen)
    else:
        # SİSTEM UYANDI -> YÜZ TANIMA BURADA ÇALIŞACAK
        # (Buraya senin mevcut yüz tanıma/SVM bloklarını ekleyeceksin)
        
        # ÖRNEK: Eğer bir yüz bulundu ve tanındıysa:
        # isim, soyisim = "Gorkem", "Celik" 
        # kaydet_excel(isim, soyisim)
        
        cv2.imshow("Gorkem Personel Takip", frame)

    if cv2.waitKey(1) & 0xFF == ord('q'):
        break

cap.release()
cv2.destroyAllWindows()
